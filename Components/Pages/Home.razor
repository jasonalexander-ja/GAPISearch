@using Google.Apis.Auth.AspNetCore3
@using Google.Apis.Auth.OAuth2
@using Google.Apis.Drive.v3
@using Google.Apis.Drive.v3.Data
@using Google.Apis.Services

@page "/"

@attribute [GoogleScopedAuthorize(DriveService.ScopeConstants.DriveReadonly)]

<PageTitle>Home</PageTitle>

<MudText Typo="Typo.h1">Hello, world!</MudText>

<MudTable Items="@Files" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@Loading" LoadingProgressColor="Color.Info">
    <HeaderContent>
        <MudTh>File Name</MudTh>
        <MudTh>Icon</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="File name">@context.Name</MudTd>
        <MudTd DataLabel="Icon">
            @string.Join(", ", context.AppProperties.Values)
        </MudTd>
    </RowTemplate>
</MudTable>



@code {

    [Inject]
    private IGoogleAuthProvider? Auth { get; set; }

    public List<File> Files { get; set; } = new List<File>();

    public bool Loading { get; set; } = true;


    protected override async Task OnParametersSetAsync()
    {
        if (Auth == null)
        {
            Console.WriteLine("Auth is null. ");
            goto End;
        }
        
        try 
        {
            GoogleCredential cred = await Auth.GetCredentialAsync();
            if (cred == null)
            {
                Console.WriteLine("Cred is null. ");
                goto End;
            }
            var service = new DriveService(new BaseClientService.Initializer
            {
                HttpClientInitializer = cred
            });
            var files = await service.Files.List().ExecuteAsync();
            Files = files.Files.ToList();
            Loading = false;
        }
        catch (Exception ex) 
        {
            Console.WriteLine($"Error encountered: {ex.Message}");
        }

        End:
        await base.OnParametersSetAsync();
    }
}
